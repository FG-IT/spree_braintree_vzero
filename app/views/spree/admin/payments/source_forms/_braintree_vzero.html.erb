<div id="payment-form" />

<script src="https://js.braintreegateway.com/v2/braintree.js"></script>
<script>
  var clientToken = "<%= payment_method.client_token(@order, @order.user) %>";
  var newPaymentFormId = "#new_payment";
  var paymentAmountFieldId = "#payment_amount";

  braintree.setup(clientToken, "dropin", {
    container: "payment-form",

    onPaymentMethodReceived: function (result) {
      if (<%= payment_method.preferred_3dsecure %> && result.type == "CreditCard") {
        var client = new braintree.api.Client({
          clientToken: clientToken
        });

        client.verify3DS({
          amount: $(paymentAmountFieldId).val(),
          creditCard: result.nonce
        }, function (error, response) {
          if (!error) {
            $(newPaymentFormId).append("<input type='hidden' name='payment_method_nonce' value=" + response.nonce + ">");
            $(newPaymentFormId).submit();
          }
        });


      } else {
        $(newPaymentFormId).append("<input type='hidden' name='payment_method_nonce' value=" + result.nonce + ">");
        $(newPaymentFormId).submit();
      }
    }

  });
</script>
