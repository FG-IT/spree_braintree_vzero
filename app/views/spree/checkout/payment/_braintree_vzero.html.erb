<div id="payment-form"></div>
<%= submit_tag Spree.t(:save_and_continue), class: 'btn btn-lg btn-success primary' %>

<hr/>
<br/>

<script src="https://js.braintreegateway.com/v2/braintree.js"></script>
<script>
  var clientToken = "<%= payment_method.client_token(current_order, current_spree_user) %>";
  var checkoutFormId = <%= payment_method.preferred_dropin_checkout_form_id %>;
  var errorMessagesContainer = <%= payment_method.preferred_dropin_error_messages_container_id %>;

  SpreeBraintreeVzero.advancedFraudTools = <%= payment_method.preferred_advanced_fraud_tools %>
  SpreeBraintreeVzero.threeDSecure = <%= payment_method.preferred_3dsecure %>

  braintree.setup(clientToken, "dropin", {
    container: "<%= payment_method.preferred_dropin_container %>",

    onPaymentMethodReceived: function (result) {
      if (SpreeBraintreeVzero.threeDSecure && result.type == "CreditCard") {
        var client = new braintree.api.Client({
          clientToken: clientToken
        });

        client.verify3DS({
          amount: <%= current_order.total %>,
          creditCard: result.nonce
        }, function (error, response) {
          if (!error) {
            $(checkoutFormId).append("<input type='hidden' name='payment_method_nonce' value=" + response.nonce + ">");
            $(checkoutFormId).submit();
          } else {
            $(errorMessagesContainer).prepend("<div class='alert alert-error'><%= I18n.t(:gateway_error, scope: 'braintree.error') %>></div>")
          }
        });


      } else {
        $(checkoutFormId).append("<input type='hidden' name='payment_method_nonce' value=" + result.nonce + ">");
        $(checkoutFormId).submit();
      }
    },

    onReady: function(integration) {
      <%= render partial: 'spree/checkout/payment/braintree_vzero/dropin_on_ready_callback', formats: [:js] %>
    },

    onError: function(error) {
      <%= render partial: 'spree/checkout/payment/braintree_vzero/dropin_on_error_callback', formats: [:js] %>
    }

  });

  SpreeBraintreeVzero.paymentMethodID = "<%= payment_method.id %>";

  if (SpreeBraintreeVzero.advancedFraudTools) {
    var BraintreeEnv = "<%= payment_method.preferred_server %>";
    var BraintreeMerchantId = "<%= payment_method.preferred_merchant_id %>";

    window.onBraintreeDataLoad = function () {
      BraintreeData.setup(BraintreeMerchantId, checkoutFormId.id, BraintreeData.environments[BraintreeEnv]);
    };
  }
</script>
<% if payment_method.preferred_advanced_fraud_tools %>
  <script src="https://js.braintreegateway.com/v1/braintree-data.js" async="true"></script>
<% end %>
